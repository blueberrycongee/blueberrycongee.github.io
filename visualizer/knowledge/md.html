<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Markdown 知识文档</title>
  <link rel="stylesheet" href="../assets/css/home.css">
  <link rel="stylesheet" href="../assets/css/theme.css">
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        displayMath: [['$$','$$'], ['\\[','\\]']],
        processEscapes: true
      },
      svg: { fontCache: 'global' }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/markdown-it-container@3.0.0/dist/markdown-it-container.min.js"></script>
  <style>
    .content-section { margin: 32px 12px; }
    .md-card { background: var(--surface); border:1px solid var(--border); border-radius:12px; padding:24px; max-width: 960px; margin: 0 auto; }
    .md-body { line-height:1.85; color: var(--fg); }
    .md-body h1, .md-body h2, .md-body h3 { margin: 12px 0 6px; }
    .md-body h1 { color:#1f6feb; font-weight:700; }
    .md-body pre { background: rgba(255,255,255,0.04); border:1px solid var(--border); border-radius:8px; padding:10px; overflow:auto; }
    .md-body blockquote { margin:8px 0; padding:8px 12px; border-left:4px solid #7aa2ff; background: rgba(122,162,255,0.12); }
    .tag-row { display:flex; flex-wrap:wrap; gap:6px; margin-bottom:8px; }
    .pill { display:inline-flex; align-items:center; padding:6px 10px; border-radius:16px; border:1px solid var(--border); background: rgba(255,255,255,0.04); font-size:13px; color: var(--fg); }
    .pill:hover { background: rgba(0,200,255,0.08); border-color:#00c8ff; color:#00c8ff; }
    .callout { border:1px solid var(--border); border-left-width:6px; border-radius:10px; padding:0; margin:12px 0; background: rgba(255,255,255,0.06); box-shadow:0 1px 2px rgba(0,0,0,0.06); }
    .callout-title { font-weight:600; display:flex; align-items:center; gap:8px; cursor:pointer; padding:10px 12px; border-bottom:1px solid var(--border); }
    .callout-body { line-height:1.8; padding:10px 12px; }
    .callout-body ol, .callout-body ul { list-style-position: inside; padding-left: 0.8em; margin: 6px 0; }
    .callout-body li { margin: 4px 0; }
    .callout.collapsed .callout-body { display:none; }
    .callout.type-question { border-left-color:#f6ad55; background: rgba(246,173,85,0.12); }
    .callout.type-summary { border-left-color:#38bdf8; background: rgba(56,189,248,0.12); }
    .callout.type-abstract { border-left-color:#a78bfa; background: rgba(167,139,250,0.12); }
    .callout.type-done { border-left-color:#22c55e; background: rgba(34,197,94,0.12); }
    .callout-icon { display:inline-flex; align-items:center; justify-content:center; width:22px; height:22px; border-radius:50%; font-size:14px; }
    .callout.type-question .callout-icon { background:#f6ad55; color:#1a1a1a; }
    .callout.type-summary .callout-icon { background:#38bdf8; color:#0b1220; }
    .callout.type-abstract .callout-icon { background:#a78bfa; color:#0b1220; }
    .callout.type-done .callout-icon { background:#22c55e; color:#0b2414; }
    .md-body hr { border: none; border-top:1px solid var(--border); margin:12px 0; }
    .md-body table { width:100%; border-collapse: collapse; margin:10px 0; }
    .md-body th, .md-body td { border:1px solid var(--border); padding:6px 8px; }
    .internal-link { color: #4a8ade; background-color: #eef5fc; border-radius: 3px; padding: 1px 4px; text-decoration: none; font-weight: 500; transition: all 0.2s ease; }
    .internal-link:hover { background-color: #dceafc; text-decoration: underline; }
    mark { background-color: #fcf8e3; color: #8a6d3b; padding: 2px 4px; border-radius: 3px; }
    .callout { border-radius: 12px; border-left: 5px solid; padding: 14px 18px; margin: 16px 0; background-color: #f9f9f9; }
    .callout-title { font-weight: 600; display: flex; align-items: center; gap: 8px; font-size: 1.05em; margin-bottom: 10px; }
    .callout-content { margin: 0; line-height: 1.85; }
    .callout-content > :first-child { margin-top: 0; }
    .callout-content > :last-child { margin-bottom: 0; }
    .callout-content ol, .callout-content ul { list-style-position: outside; padding-left: 1.2em; margin: 8px 0; }
    .callout-note { border-color: #4a8ade; background-color: #f0f6fd; }
    .callout-warning { border-color: #f0ad4e; background-color: #fcf8e3; }
    .callout-danger { border-color: #d9534f; background-color: #f2dede; }
    .callout.collapsed .callout-content { display:none; }
    .mjx-block mjx-container { display:block; margin:12px auto; }
    mjx-container[display="true"] { margin:14px 0; }
    .floating-ref-btn { position: fixed; right: 16px; top: 50%; transform: translateY(-50%); z-index: 1000; display:inline-flex; align-items:center; padding:8px 14px; border-radius:999px; border:1px solid var(--line); background: var(--surface); color: var(--fg); text-decoration:none; box-shadow: 0 6px 14px rgba(0,0,0,0.12); }
    .floating-ref-btn:hover { background: var(--surface-hover); border-color: var(--accent); color: var(--accent); }
  </style>
</head>
<body>
  <div class="home-container">
    <header class="header">
      <h1>知识点库 — Markdown</h1>
      <p class="subtitle">外部 Markdown 知识文档查看与联动</p>
    </header>
    <main class="main-content">
      <section class="content-section">
        <div class="md-card">
          <div id="ref-back" style="text-align:right;margin-bottom:8px;"></div>
          <div id="fm-tags" class="tag-row"></div>
          <article id="md" class="md-body"></article>
        </div>
      </section>
    </main>
    <footer class="footer"><p>知识点库 © 2024</p></footer>
  </div>
  <script>
    (function(){
      function qs(key){ var s=location.search.replace(/^\?/,'').split('&').filter(Boolean).map(function(p){ var i=p.indexOf('='); return [decodeURIComponent(p.slice(0,i)), decodeURIComponent(p.slice(i+1))]; }); var o={}; s.forEach(function(kv){ o[kv[0]]=kv[1]; }); return o[key]; }
      function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
      function parseFrontMatter(t){
        var tags=[]; var body=t;
        if(/^---\s*\n/.test(t)){ var end = t.indexOf('\n---'); if(end>-1){ var fm = t.slice(4, end); body = t.slice(end+4); var lines = fm.split(/\r?\n/); for(var i=0;i<lines.length;i++){ var l=lines[i]; if(/^tags\s*:\s*/i.test(l)){ var v=l.replace(/^tags\s*:\s*/i,'').trim(); if(v[0]==='['){ try{ var arr=JSON.parse(v); if(Array.isArray(arr)) tags = arr.map(function(s){ return String(s).trim(); }); }catch(e){} } } } } }
        return { body: body, tags: tags };
      }
      function convertCallouts(t){
        var lines=t.replace(/\r\n/g,'\n').split('\n');
        var out=[]; var i=0;
        while(i<lines.length){
          var l=lines[i]; var m=l.trim().match(/^>\s*\[!([a-zA-Z]+)\](?:\s*([-+]))?\s*(.*)$/);
          if(m){ var type=m[1].toLowerCase(); var collapsed=(m[2]==='-'); var title=m[3]||m[1]; i++; var body=[]; while(i<lines.length && /^>/.test(lines[i].trim())){ body.push(lines[i].replace(/^\s*>\s?/,'')); i++; } out.push('::: callout type='+type+' collapsed='+(collapsed?'true':'false')+' title='+JSON.stringify(title)); out.push(body.join('\n')); out.push(':::'); continue; }
          out.push(l); i++;
        }
        return out.join('\n');
      }
      function setupMd(from){
        var md=window.markdownit({ html:true, linkify:true, typographer:true });
        md.inline.ruler.before('emphasis','highlight_inline',function(state,silent){ var src=state.src; var pos=state.pos; if(src.charCodeAt(pos)!==0x3D || src.charCodeAt(pos+1)!==0x3D) return false; var start=pos+2; var end=src.indexOf('==', start); if(end<0) return false; var content=src.slice(start,end); if(!silent){ var token=state.push('highlight_inline','',0); token.content=content; } state.pos=end+2; return true; });
        md.renderer.rules.highlight_inline=function(tokens, idx){ var c=tokens[idx].content; return '<mark>'+md.utils.escapeHtml(c)+'</mark>'; };
        md.inline.ruler.before('emphasis','math_inline',function(state,silent){ var src=state.src, pos=state.pos; if(src.charCodeAt(pos)!==0x24 /* $ */) return false; var start=pos+1; // single-dollar only
          if(src.charCodeAt(start)===0x24) return false; // skip $$ (display handled elsewhere)
          // opening $ must have non-space on right
          if(start>=src.length || /\s/.test(src[start])) return false;
          var end=start; var found=false; while((end=src.indexOf('$', end))>-1){ if(end>start && src.charCodeAt(end-1)!==0x5C /* \\ */){ // closing $ must have non-space on left and not $$
              if(/\s/.test(src[end-1])) { end++; continue; }
              if(src.charCodeAt(end+1)===0x24) { end++; continue; }
              found=true; break; } end++; }
          if(!found) return false; var content=src.slice(start, end);
          if(!silent){ var token=state.push('math_inline','',0); token.content=content; }
          state.pos=end+1; return true; });
        md.renderer.rules.math_inline=function(tokens, idx){ var c=tokens[idx].content; return '\\('+md.utils.escapeHtml(c)+'\\)'; };
        md.inline.ruler.before('emphasis','wikilink',function(state,silent){ var src=state.src; var pos=state.pos; if(src.charCodeAt(pos)!==0x5B || src.charCodeAt(pos+1)!==0x5B) return false; var start=pos+2; var end=src.indexOf(']]', start); if(end<0) return false; var content=src.slice(start,end); var name=content; var alias; var pipe=content.indexOf('|'); if(pipe>-1){ name=content.slice(0,pipe).trim(); alias=content.slice(pipe+1).trim(); } else { name=name.trim(); alias=name; } if(!silent){ var token=state.push('wikilink','',0); token.meta={ name:name, alias:alias }; } state.pos=end+2; return true; });
        md.renderer.rules.wikilink=function(tokens, idx, options, env){ var fromEnv=env && env.from; var name=tokens[idx].meta.name; var alias=tokens[idx].meta.alias || name; var fn='md.html?file='+encodeURIComponent(name)+'.md'+(fromEnv?('&from='+fromEnv):''); return '<a class="internal-link" href="'+fn+'">'+md.utils.escapeHtml(alias)+'</a>'; };
        md.use(window.markdownitContainer, 'callout', { validate:function(params){ return /^callout\b/.test(params.trim()); }, render:function(tokens, idx){ var info=(tokens[idx].info||'').trim(); var rest=info.replace(/^callout\b\s*/, ''); var mTitle=rest.match(/title=\"([\s\S]*?)\"/); var title=mTitle?mTitle[1]:''; rest=rest.replace(/title=\"[\s\S]*?\"/,'').trim(); var type='note'; var collapsed=false; rest.split(/\s+/).forEach(function(seg){ if(!seg) return; var kv=seg.split('='); var k=kv[0]; var v=kv[1]; if(k==='type'){ type=String(v||'note').toLowerCase(); } else if(k==='collapsed'){ collapsed=(String(v)==='true'); } }); var map={ question:'note', summary:'note', abstract:'note', done:'note', note:'note', warning:'warning', danger:'danger' }; var t=map[type]||'note'; if(tokens[idx].nesting===1){ var cls='callout callout-'+t+(collapsed?' collapsed':''); var titleHtml=md.renderInline(title||type); return '<div class="'+cls+'"><div class="callout-title">'+titleHtml+'</div><div class="callout-content">'; } else { return '</div></div>'; } } });
        return md;
      }
      function renderMd(text, from){
        var meta=parseFrontMatter(String(text||''));
        var body=convertCallouts(meta.body||'');
        body = body.replace(/(^|\n)[ \t]*\$\$([\s\S]*?)\$\$[ \t]*(?=\n|$)/g, function(_, pre, math){ var content=String(math||'').replace(/^\s+|\s+$/g,''); return pre+'\n<div class="mjx-block">\\['+content+'\\]</div>\n'; });
        var md=setupMd(from);
        var html=md.render(body, { from: from });
        var tagEl=document.getElementById('fm-tags'); tagEl.innerHTML=(meta.tags||[]).map(function(t){ return '<span class="pill">'+esc(t)+'</span>'; }).join('');
        return html;
      }
      function normalizeInlineMath(root){
        var tw=document.createTreeWalker(root, NodeFilter.SHOW_TEXT, null);
        var re=/(^|[^\\])\$(?!\$)([^$]+?)\$(?!\$)/g;
        while(tw.nextNode()){
          var n=tw.currentNode; var p=n.parentNode; if(!p) continue; var tag=(p.nodeName||'').toLowerCase();
          if(/^(script|style|textarea|pre|code|svg|mjx-container)$/.test(tag)) continue;
          var s=n.nodeValue; if(!s || s.indexOf('$')===-1) continue;
          var t=s.replace(re, function(_, pre, content){ return pre+'\\('+content+'\\)'; });
          if(t!==s){ n.nodeValue=t; }
        }
      }
      var header=document.querySelector('.header');
      var from=qs('from');
      var left=document.createElement('a'); left.className='back-link'; left.style.position='absolute'; left.style.left='20px'; left.style.top='20px';
      if(from){
        var map={ ds:'ds.html', os:'os.html', arch:'arch.html', network:'network.html' };
        left.textContent='← 返回上一级'; left.href= map[from] || 'index.html';
      } else {
        left.textContent='← 返回知识点库'; left.href='index.html';
      }
      header.appendChild(left);

      var ref=qs('ref'); if(ref){ var a=document.createElement('a'); a.className='floating-ref-btn'; a.textContent='← 返回刷题'; var href=ref; if(/^\//.test(href) && !/^\/visualizer\//.test(href)){ href='/visualizer'+href; } else if(!/^https?:\/\//i.test(href) && !/^\//.test(href)){ href='../'+href.replace(/^\.\/?/,''); } a.href=href; document.body.appendChild(a); }
      var file=qs('file'); if(!file){ document.getElementById('md').innerHTML='<div class="notice">未指定文件参数 <code>?file=...</code></div>'; return; }
      fetch(file).then(function(r){ return r.text(); }).then(function(txt){ var html=renderMd(txt, from); var el=document.getElementById('md'); el.innerHTML=html; normalizeInlineMath(el); if(window.MathJax && window.MathJax.typesetPromise){ if(window.MathJax.startup && window.MathJax.startup.promise){ window.MathJax.startup.promise.then(function(){ return window.MathJax.typesetPromise([el]); }); } else { window.MathJax.typesetPromise([el]); } } var cards=document.querySelectorAll('.callout-title'); cards.forEach(function(c){ c.addEventListener('click', function(){ var p=c.parentElement; p.classList.toggle('collapsed'); normalizeInlineMath(p); if(window.MathJax && window.MathJax.typesetPromise){ window.MathJax.typesetPromise([p]); } }); }); }).catch(function(){ document.getElementById('md').innerHTML='<div class="notice">无法加载指定文件</div>'; });
    })();
  </script>
  <script src="../assets/js/theme.js"></script>
</body>
</html>