/* exam viewer logic (static-compatible) */
(function(){
  function qs(key){ var s = location.search.replace(/^\?/, '').split('&').filter(Boolean).map(function(p){ var i=p.indexOf('='); return [decodeURIComponent(p.slice(0,i)), decodeURIComponent(p.slice(i+1))]; }); var o={}; s.forEach(function(kv){ o[kv[0]] = kv[1]; }); return o[key]; }
  function mapTag(t){ var idx = (window.KNOWLEDGE_INDEX || {}); return idx[t] || null; }
  function textToLines(txt){ return (txt||'').replace(/\r\n/g,'\n').split('\n'); }
  function trim(s){ return (s||'').replace(/^[\s\u00A0\u3000]+|[\s\u00A0\u3000]+$/g,''); }
  function parseTags(v){
    if(!v) return [];
    if(v[0]==='['&&v[v.length-1]===']'){
      try{ var a=JSON.parse(v); return Array.isArray(a)?a.map(function(x){ return String(x).trim(); }):[]; }catch(e){}
    }
    var s = String(v).replace(/^\[\s*/, '').replace(/\s*\]$/, '');
    var raw = s.split(/[,，\s]+/).map(function(x){ return x.replace(/^["']|["']$/g,'').trim(); }).filter(Boolean);
    var out = []; raw.forEach(function(tok){ var hasHan=/[\u4e00-\u9fff]/.test(tok); var idxAscii=tok.search(/[A-Za-z0-9_*]+/); if(hasHan && idxAscii>0){ out.push(tok.slice(0,idxAscii)); out.push(tok.slice(idxAscii)); } else { out.push(tok); } });
    return out;
  }
  function isOptionLine(t){ return /^(\(?[A-Z]\)|（[A-Z]）)/.test(t) || /^([A-Z])\s*[\.．、]/.test(t); }
  function cleanupBody(s){ var x=String(s||''); x=x.replace(/^[\s\t]*(\r?\n)+/, ''); x=x.replace(/(\r?\n){3,}/g, '\n\n'); x=x.replace(/(\r?\n)+\s*$/, ''); x=x.split(/\r?\n/).map(function(l){ return l.replace(/^[\s\u00A0\u3000]+/, ''); }).join('\n'); return x; }
  function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function paperKey(){ return qs('paper') || 'paper'; }
  function loadProf(){ try{ var k='exam_proficiency:'+paperKey(); var s=localStorage.getItem(k); return s?JSON.parse(s):{}; }catch(e){ return {}; } }
  function saveProf(obj){ try{ var k='exam_proficiency:'+paperKey(); localStorage.setItem(k, JSON.stringify(obj||{})); }catch(e){} }
  function parseMarkdown(md){ var lines=textToLines(md), i=0, res=[]; var paperTitle='试卷'; var currentSubject=''; var currentSection=''; while(i<lines.length){ var line=trim(lines[i]); if(i===0 && /^#\s+/.test(line)){ paperTitle=trim(line.replace(/^#+\s+/,'')); i++; continue; } if(/^###\s*(数据结构|操作系统|组成原理|计算机网络)\s*$/.test(line)){ currentSubject=trim(line.replace(/^###\s*/,'')); currentSection=''; i++; continue; } if(/^(\*\*\s*)?[一二三四五六七八九十]+、\s*判断题(\s*\*\*)?$/.test(line) || /^\*\*?\s*判断题\s*\*\*?$/.test(line)){ currentSection='判断题'; i++; continue; } if(/^(\*\*\s*)?[一二三四五六七八九十]+、\s*选择题(\s*\*\*)?$/.test(line) || /^\*\*?\s*选择题\s*\*\*?$/.test(line){ currentSection='选择题'; i++; continue; } if(/^(\*\*\s*)?[一二三四五六七八九十]+、\s*填空题(\s*\*\*)?$/.test(line) || /^\*\*?\s*填空题\s*\*\*?$/.test(line){ currentSection='填空题'; i++; continue; } if(/^(\*\*\s*)?[一二三四五六七八九十]+、\s*解答题(\s*\*\*)?$/.test(line) || /^\*\*?\s*解答题\s*\*\*?$/.test(line){ currentSection='解答题'; i++; continue; } if(/^###\s+/.test(line)){ var q={ title: trim(line.replace(/^###\s+/,'')), tags:[], difficulty:'', knowledge:'', body:'', options:[], answer:'', solution:'' }; i++; while(i<lines.length && /^(tags|标签|difficulty|难度|knowledge|知识点)\s*:\s*/i.test(trim(lines[i]))){ var kv=trim(lines[i]).split(':'); var k=trim(kv[0]).toLowerCase(); var v=trim(kv.slice(1).join(':')); if(k==='tags' || k==='标签'){ q.tags=parseTags(v); } else if(k==='difficulty' || k==='难度'){ q.difficulty=v; } else if(k==='knowledge' || k==='知识点'){ q.knowledge=v; } i++; } while(i<lines.length && trim(lines[i])==='') i++; if(i<lines.length && /^题目\s*[:：]/.test(trim(lines[i]))){ i++; } var body=[]; while(i<lines.length && !/^选项\s*[:：]/.test(trim(lines[i])) && !/^答案\s*[:：]/.test(trim(lines[i])) && !/^解析\s*[:：]/.test(trim(lines[i])) && !/^###\s+/.test(trim(lines[i]))){ var tl=trim(lines[i]); if(isOptionLine(tl)) break; body.push(lines[i]); i++; } q.body=cleanupBody(body.join('\n')); if(i<lines.length && /^选项\s*[:：]/.test(trim(lines[i]))){ i++; var opts=[]; while(i<lines.length && !/^答案\s*[:：]/.test(trim(lines[i])) && !/^解析\s*[:：]/.test(trim(lines[i])) && !/^###\s+/.test(trim(lines[i]))){ var t=trim(lines[i]); if(isOptionLine(t)){ opts.push(t); } else if(t!==''){ opts.push(t); } i++; } q.options=opts; } else if(i<lines.length && isOptionLine(trim(lines[i]))){ var opts=[]; while(i<lines.length && !/^答案\s*[:：]/.test(trim(lines[i])) && !/^解析\s*[:：]/.test(trim(lines[i])) && !/^###\s+/.test(trim(lines[i]))){ var t=trim(lines[i]); if(isOptionLine(t)){ opts.push(t); } else if(t!==''){ opts.push(t); } i++; } q.options=opts; } if(i<lines.length && /^答案\s*[:：]/.test(trim(lines[i]))){ q.answer=trim(lines[i]).replace(/^答案\s*[:：]/,''); i++; } if(i<lines.length && /^解析\s*[:：]/.test(trim(lines[i]))){ i++; var sol=[]; while(i<lines.length && !/^###\s+/.test(trim(lines[i]))){ sol.push(lines[i]); i++; } q.solution=sol.join('\n'); } res.push(q); continue; } if(currentSection && /^\d+\.\s*/.test(line)){ var num=parseInt((line.match(/^\d+/) || ['0'])[0],10); var q={ title:(currentSubject?(currentSubject+' '+currentSection+' '+num):('题目 '+num)), tags:[currentSubject,currentSection].filter(Boolean), difficulty:'', knowledge:'', body:'', options:[], answer:'', solution:'' }; var body=[trim(line.replace(/^\d+\.\s*/,''))]; i++; while(i<lines.length){ var tline=trim(lines[i]); if(/^###\s+/.test(tline) || /^\d+\.\s+/.test(tline) || /^(\*\*\s*)?[一二三四五六七八九十]+、/.test(tline) || /^---+$/.test(tline)) break; if(/^(tags|标签|difficulty|难度|knowledge|知识点)\s*[:：]/i.test(tline)){ var kv=tline.split(':'); var k=trim(kv[0]).toLowerCase(); var v=trim(kv.slice(1).join(':')); if(k==='tags' || k==='标签'){ q.tags=q.tags.concat(parseTags(v)); } else if(k==='difficulty' || k==='难度'){ q.difficulty=v; } else if(k==='knowledge' || k==='知识点'){ q.knowledge=v; } i++; continue; } if(/^选项\s*[:：]/.test(tline)){ i++; var opts=[]; while(i<lines.length){ var t2=trim(lines[i]); if(/^###\s+/.test(t2) || /^\d+\.\s+/.test(t2) || /^(\*\*\s*)?[一二三四五六七八九十]+、/.test(t2)) break; if(/^答案\s*[:：]/.test(t2) || /^解析\s*[:：]/.test(t2)) break; if(isOptionLine(t2)){ opts.push(t2); } else if(t2!==''){ opts.push(t2); } i++; } q.options=opts; continue; } if(isOptionLine(tline)){ var opts=[]; while(i<lines.length){ var t2=trim(lines[i]); if(/^###\s+/.test(t2) || /^\d+\.\s+/.test(t2) || /^(\*\*\s*)?[一二三四五六七八九十]+、/.test(t2)) break; if(/^答案\s*[:：]/.test(t2) || /^解析\s*[:：]/.test(t2)) break; if(isOptionLine(t2)){ opts.push(t2); } else if(t2!==''){ opts.push(t2); } i++; } q.options=opts; continue; } if(/^答案\s*[:：]/.test(tline)){ q.answer=trim(tline).replace(/^答案\s*[:：]/,''); i++; continue; } if(/^解析\s*[:：]/.test(tline)){ i++; var sol=[]; while(i<lines.length){ var t2=trim(lines[i]); if(/^###\s+/.test(t2) || /^\d+\.\s+/.test(t2) || /^(\*\*\s*)?[一二三四五六七八九十]+、/.test(t2) || /^---+$/.test(t2)) break; sol.push(lines[i]); i++; } q.solution=sol.join('\n'); continue; } body.push(lines[i]); i++; } q.body=cleanupBody(body.join('\n')); res.push(q); continue; } i++; } return { title:paperTitle, questions:res }; }
  function renderPaper(p){ var titleEl=document.getElementById('paper-title'); if(titleEl) titleEl.textContent=p.title||'试卷'; var container=document.getElementById('questions'); var empty=document.getElementById('empty'); if(!container) return; if(!p.questions || p.questions.length===0){ empty && empty.classList.remove('hidden'); return; } empty && empty.classList.add('hidden'); var prof=loadProf(); container.innerHTML=p.questions.map(function(q,idx){ var tagsHTML=(q.tags||[]).map(function(t){ var href=mapTag(t); if(href){ var paper=qs('paper')||''; var parts=String(href).split('#'); var base=parts[0]; var hash=parts[1]?('#'+parts[1]):''; var ref='/exam-viewer.html?paper='+encodeURIComponent(paper)+'&goto='+idx; var join=base.indexOf('?')>-1?'&':'?'; var link=base+join+'ref='+encodeURIComponent(ref)+hash; return '<a class="pill" href="'+link+'">'+t+'</a>'; } return '<span class="pill">'+t+'</span>'; }).join(''); var learnHref=null; (q.tags||[]).some(function(t){ var h=mapTag(t); if(h){ var paper=qs('paper')||''; var parts=String(h).split('#'); var base=parts[0]; var hash=parts[1]?('#'+parts[1]):''; var ref='/exam-viewer.html?paper='+encodeURIComponent(paper)+'&goto='+idx; var join=base.indexOf('?')>-1?'&':'?'; learnHref=base+join+'ref='+encodeURIComponent(ref)+hash; return true; } return false; }); var optsHTML=(q.options||[]).length?('<div class="q-options">'+q.options.map(function(o){ return '<div>'+esc(o)+'</div>'; }).join('')+'</div>'):''; var meta=[q.difficulty?('难度：'+q.difficulty):'', (q.knowledge||'')].filter(Boolean).join(' · '); var solBtn='<div class="q-ops"><button class="btn btn-sol" data-toggle="sol" data-idx="'+idx+'">解析</button>'+(learnHref?('<a class="btn" href="'+learnHref+'">去学</a>'):'')+'</div>'; var sol=(function(){ var ans=q.answer?('<div><strong>答案：</strong>'+esc(q.answer)+'</div>'):''; var body=esc(q.solution||'解析占位（待补充）'); return '<div class="q-solution hidden" id="sol-'+idx+'">'+ans+'<div style="white-space:pre-wrap;">'+body+'</div></div>'; })(); var r=parseInt(prof[String(idx)]||0,10); var labels={1:'初看懂',2:'仿着做',3:'查资料',4:'独立解',5:'能迁移'}; var rate='<div class="q-rate">'+[1,2,3,4,5].map(function(n){ return '<button class="pill'+(r===n?' active':'')+'" data-rating="'+n+'" data-idx="'+idx+'">'+n+'级·'+labels[n]+'</button>'; }).join('')+'</div>'; return '<div class="question" id="q-'+idx+'"><div class="q-title">'+(q.title||('第 '+(idx+1)+' 题'))+'</div><div class="q-meta">'+meta+'</div><div class="q-body" style="white-space:pre-line;">'+esc(q.body||'')+'</div>'+optsHTML+rate+'<div class="q-tags">'+tagsHTML+'</div>'+solBtn+sol+'</div>'; }).join(''); if(window.MathJax && window.MathJax.typesetPromise){ window.MathJax.typesetPromise([container]); } }
  function attachEvents(p){ var container=document.getElementById('questions'); var search=document.getElementById('search'); var toggleAll=document.getElementById('toggleAnswers'); if(search){ search.addEventListener('input', function(){ var q=trim(search.value).toLowerCase(); var nodes=container.querySelectorAll('.question'); nodes.forEach(function(n){ var text=n.textContent.toLowerCase(); n.style.display = q && text.indexOf(q)===-1 ? 'none' : ''; }); }); } if(container){ container.addEventListener('click', function(e){ var t=e.target; if(t && t.dataset && t.dataset.toggle==='sol'){ var idx=t.dataset.idx; var el=document.getElementById('sol-'+idx); if(el){ el.classList.toggle('hidden'); } } if(t && t.dataset && t.dataset.rating){ var idx=t.dataset.idx; var level=parseInt(t.dataset.rating,10)||0; var prof=loadProf(); prof[String(idx)]=level; saveProf(prof); var peers=container.querySelectorAll('.q-rate [data-idx="'+idx+'"]'); peers.forEach(function(el){ el.classList.toggle('active', el.dataset.rating==String(level)); }); } }); } if(toggleAll){ toggleAll.addEventListener('click', function(){ var els=container.querySelectorAll('.q-solution'); els.forEach(function(el){ el.classList.toggle('hidden'); }); }); } var gotoIdx=parseInt(qs('goto')||'',10); if(!isNaN(gotoIdx)){ var el=document.getElementById('q-'+gotoIdx); if(el){ el.scrollIntoView({ behavior:'smooth', block:'start' }); } } }
  function tryFetch(urls){ var u=urls.slice(); function next(resolve,reject){ if(u.length===0){ reject(new Error('not found')); return; } var url=u.shift(); fetch(url).then(function(r){ var isFile=(typeof location!=='undefined' && location.protocol==='file:'); if(!isFile && !r.ok) throw new Error('fail'); return r.text(); }).then(function(txt){ if(!txt || !String(txt).trim()) throw new Error('empty'); resolve({ url:url, text:txt }); }).catch(function(){ next(resolve,reject); }); } return new Promise(function(resolve,reject){ next(resolve,reject); }); }
  document.addEventListener('DOMContentLoaded', function(){ var paper=qs('paper'); var titleEl=document.getElementById('paper-title'); if(!paper){ titleEl && (titleEl.textContent='试卷（未指定）'); document.getElementById('empty').classList.remove('hidden'); return; } var urls=['papers/'+paper, paper, '计算机网络/'+paper]; tryFetch(urls).then(function(res){ var parsed=parseMarkdown(res.text); renderPaper(parsed); attachEvents(parsed); }).catch(function(){ document.getElementById('empty').classList.remove('hidden'); }); });
})();